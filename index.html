<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Turnos de Limpieza</title>
  <style>
    :root {
      color-scheme: dark;
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
      --bg: #0f172a;
      --bg-card: rgba(15, 23, 42, 0.92);
      --bg-input: rgba(30, 41, 59, 0.75);
      --bg-input-focus: rgba(51, 65, 85, 0.85);
      --fg: #e2e8f0;
      --fg-muted: #94a3b8;
      --accent: #38bdf8;
      --accent-strong: #0ea5e9;
      --success: #34d399;
      --error: #f87171;
      --warning: #fbbf24;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 32px 16px;
      background: radial-gradient(circle at top, #1e293b, #020617 70%);
      color: var(--fg);
    }

    .app {
      width: min(420px, 94vw);
      padding: 32px 28px 36px;
      border-radius: 24px;
      background: var(--bg-card);
      box-shadow: 0 20px 50px rgba(2, 6, 23, 0.55);
      border: 1px solid rgba(148, 163, 184, 0.12);
      backdrop-filter: blur(14px);
    }

    h1 {
      font-size: clamp(1.9rem, 4vw, 2.3rem);
      margin: 0 0 0.4rem;
      color: #f8fafc;
      letter-spacing: -0.01em;
    }

    .subtitle {
      margin: 0 0 1.8rem;
      color: var(--fg-muted);
      font-size: 0.98rem;
      line-height: 1.4;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 18px;
    }

    label {
      font-weight: 600;
      font-size: 0.95rem;
      color: #f1f5f9;
      letter-spacing: 0.01em;
    }

    select,
    input[type="date"] {
      width: 100%;
      border: 1px solid transparent;
      border-radius: 14px;
      padding: 13px 15px;
      font-size: 0.98rem;
      color: var(--fg);
      background: var(--bg-input);
      transition: border-color 0.2s ease, background 0.2s ease, box-shadow 0.2s ease;
    }

    select {
      appearance: none;
      background-image: linear-gradient(45deg, transparent 50%, rgba(148, 163, 184, 0.65) 50%),
        linear-gradient(135deg, rgba(148, 163, 184, 0.65) 50%, transparent 50%);
      background-position: calc(100% - 22px) calc(50% - 5px), calc(100% - 16px) calc(50% - 5px);
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
      padding-right: 42px;
      cursor: pointer;
    }

    select option {
      color: var(--fg);
      background: var(--bg);
    }

    select:focus,
    input[type="date"]:focus {
      outline: none;
      border-color: rgba(56, 189, 248, 0.65);
      background: var(--bg-input-focus);
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.28);
    }

    .anchor-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 12px;
    }

    .anchor-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .switch {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      font-size: 0.9rem;
      color: var(--fg-muted);
    }

    .switch input {
      display: none;
    }

    .switch-track {
      position: relative;
      width: 44px;
      height: 24px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.25);
      transition: background 0.25s ease;
    }

    .switch-handle {
      position: absolute;
      top: 3px;
      left: 4px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #f8fafc;
      transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.35);
    }

    .switch input:checked + .switch-track {
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
    }

    .switch input:checked + .switch-track .switch-handle {
      transform: translateX(18px);
      background: #ecfeff;
    }

    button {
      width: 100%;
      margin-top: 12px;
      border: none;
      border-radius: 16px;
      padding: 14px 18px;
      font-size: 1.02rem;
      font-weight: 600;
      letter-spacing: 0.01em;
      color: #0f172a;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 24px rgba(14, 165, 233, 0.35);
    }

    button:active {
      transform: translateY(0);
      box-shadow: none;
    }

    small {
      color: var(--fg-muted);
      line-height: 1.4;
    }

    #resultado {
      margin-top: 24px;
      padding: 18px 20px;
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.18);
      background: rgba(30, 41, 59, 0.62);
      backdrop-filter: blur(10px);
      font-size: 0.98rem;
      line-height: 1.6;
      display: none;
    }

    #resultado[data-state] {
      display: block;
    }

    #resultado[data-state="success"] {
      border-color: rgba(52, 211, 153, 0.45);
      background: rgba(6, 95, 70, 0.18);
    }

    #resultado[data-state="error"] {
      border-color: rgba(248, 113, 113, 0.45);
      background: rgba(185, 28, 28, 0.16);
    }

    #resultado[data-state="warning"] {
      border-color: rgba(251, 191, 36, 0.45);
      background: rgba(234, 179, 8, 0.16);
    }

    #resultado strong {
      color: #f8fafc;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.14);
      font-size: 0.78rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--fg-muted);
    }

    .pill.accent {
      background: rgba(56, 189, 248, 0.16);
      color: #bae6fd;
    }

    .checkin {
      margin-top: 24px;
      padding: 22px 20px;
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.18);
      background: rgba(15, 23, 42, 0.72);
      backdrop-filter: blur(12px);
      display: none;
    }

    .checkin[aria-hidden="false"] {
      display: block;
    }

    .checkin-header {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 14px;
    }

    .checkin-title {
      font-size: 1.02rem;
      font-weight: 600;
      color: #f8fafc;
    }

    .checkin-subtitle {
      font-size: 0.88rem;
      color: var(--fg-muted);
    }

    .checkin-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .checkin-item {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 12px;
      align-items: center;
      padding: 12px 14px;
      border-radius: 14px;
      background: rgba(30, 41, 59, 0.58);
      border: 1px solid rgba(148, 163, 184, 0.12);
    }

    .checkin-item input[type="checkbox"] {
      width: 22px;
      height: 22px;
      accent-color: var(--accent-strong);
      cursor: pointer;
    }

    .checkin-label {
      display: flex;
      flex-direction: column;
      gap: 4px;
      color: #e2e8f0;
    }

    .checkin-name {
      font-weight: 600;
      font-size: 0.98rem;
    }

    .checkin-task {
      font-size: 0.86rem;
      color: var(--fg-muted);
    }

    .checkin-meta {
      margin-top: 6px;
      font-size: 0.78rem;
      color: rgba(148, 163, 184, 0.8);
    }

    .checkin-meta time {
      color: #f8fafc;
    }

    @media (max-width: 480px) {
      .app {
        padding: 28px 22px 32px;
        border-radius: 20px;
      }

      button {
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>
  <main class="app">
    <h1>Turnos de limpieza</h1>
    <p class="subtitle">Selecciona tu nombre (Alberto, Victor, Irene o Murci) y una fecha (AAAA-MM-DD). Te dirá qué parte de la casa te toca según el ciclo de 4 semanas.</p>

    <div class="field">
      <label for="nombre">Nombre</label>
      <select id="nombre">
        <option value="">Selecciona una persona…</option>
        <option value="Alberto">Alberto</option>
        <option value="Victor">Victor</option>
        <option value="Irene">Irene</option>
        <option value="Murci">Murci</option>
      </select>
    </div>

    <div class="field">
      <label for="fecha">Fecha</label>
      <input id="fecha" type="date" />
    </div>

    <div class="field">
      <div class="anchor-grid">
        <label for="anchor">Anclar Semana 1 a</label>
        <div class="anchor-meta">
          <input id="anchor" type="date" value="2025-09-29" />
          <label class="switch">
            <input id="anchor-toggle" type="checkbox" />
            <span class="switch-track"><span class="switch-handle"></span></span>
            Activar
          </label>
        </div>
        <small>Si eliges una fecha distinta y activas el anclaje, esa fecha tiene prioridad. Si no, puedes marcar la casilla para empezar el ciclo desde tu propia fecha.</small>
      </div>
    </div>

    <button type="button" onclick="calcularTurno()">Calcular turno</button>

    <div id="resultado"></div>
    <section id="checkin-panel" class="checkin" aria-hidden="true">
      <div class="checkin-header">
        <span class="checkin-title">Check-in semanal</span>
        <span class="checkin-subtitle" id="checkin-week-info"></span>
        <small>Marca la casilla cuando termines tu tarea. El estado queda guardado en este dispositivo para poder revisarlo después.</small>
      </div>
      <ul id="checkin-list" class="checkin-list"></ul>
    </section>
  </main>

  <script>
    const TAREAS = ["Salón", "Cocina", "Baños", "Libre"];
    const CUADRANTE = [
      ["Alberto", "Irene", "Victor", "Murci"],
      ["Murci", "Alberto", "Irene", "Victor"],
      ["Victor", "Murci", "Alberto", "Irene"],
      ["Irene", "Victor", "Murci", "Alberto"]
    ];

    const BASE_DATE_ISO = "2025-09-29";
    const STORAGE_PREFIX = "turnos-checkin::";

    function norm(s) {
      return s
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .trim();
    }

    function semanasEntre(base, fecha) {
      const msSemana = 1000 * 60 * 60 * 24 * 7;
      return Math.floor((fecha - base) / msSemana);
    }

    function parseDateOrNull(value) {
      if (!value) return null;
      const parsed = new Date(value + "T00:00:00");
      return Number.isNaN(parsed.getTime()) ? null : parsed;
    }

    function setResultado(html, state = "info") {
      const panel = document.getElementById("resultado");
      panel.innerHTML = html;
      if (html) {
        panel.dataset.state = state;
      } else {
        delete panel.dataset.state;
      }
    }

    function hideCheckinPanel() {
      const panel = document.getElementById("checkin-panel");
      panel.setAttribute("aria-hidden", "true");
      document.getElementById("checkin-list").innerHTML = "";
      document.getElementById("checkin-week-info").textContent = "";
    }

    function getCheckinKey(baseIso, fechaIso) {
      return `${STORAGE_PREFIX}${baseIso}::${fechaIso}`;
    }

    function readCheckins(key) {
      try {
        const stored = localStorage.getItem(key);
        return stored ? JSON.parse(stored) : {};
      } catch (error) {
        console.warn("No se pudieron leer los check-in almacenados", error);
        return {};
      }
    }

    function writeCheckins(key, data) {
      try {
        localStorage.setItem(key, JSON.stringify(data));
      } catch (error) {
        console.warn("No se pudieron guardar los check-in", error);
      }
    }

    function formatDateTimeForHuman(date) {
      return date.toLocaleString("es-ES", {
        year: "numeric",
        month: "long",
        day: "numeric",
        hour: "2-digit",
        minute: "2-digit"
      });
    }

    function renderCheckinPanel(idxSemana, fechaIso, baseIso, fechaHumana) {
      const panel = document.getElementById("checkin-panel");
      const list = document.getElementById("checkin-list");
      const weekInfo = document.getElementById("checkin-week-info");
      const key = getCheckinKey(baseIso, fechaIso);
      const registros = readCheckins(key);

      list.innerHTML = "";
      weekInfo.textContent = `Ciclo semana ${idxSemana + 1} · ${fechaHumana}`;

      CUADRANTE[idxSemana].forEach((persona, index) => {
        const personaKey = norm(persona);
        const registro = registros[personaKey];
        const item = document.createElement("li");
        item.className = "checkin-item";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.id = `checkin-${personaKey}`;
        checkbox.checked = Boolean(registro?.done);

        checkbox.addEventListener("change", () => {
          const nuevoRegistro = {
            done: checkbox.checked,
            timestamp: checkbox.checked ? new Date().toISOString() : null
          };
          const actualizados = { ...readCheckins(key) };
          if (checkbox.checked) {
            actualizados[personaKey] = nuevoRegistro;
          } else {
            delete actualizados[personaKey];
          }
          writeCheckins(key, actualizados);
          renderCheckinPanel(idxSemana, fechaIso, baseIso, fechaHumana);
        });

        const label = document.createElement("label");
        label.className = "checkin-label";
        label.htmlFor = checkbox.id;

        const nombreSpan = document.createElement("span");
        nombreSpan.className = "checkin-name";
        nombreSpan.textContent = persona;

        const tareaSpan = document.createElement("span");
        tareaSpan.className = "checkin-task";
        tareaSpan.textContent = `Tarea: ${TAREAS[index]}`;

        label.append(nombreSpan, tareaSpan);

        if (registro?.timestamp) {
          const meta = document.createElement("div");
          meta.className = "checkin-meta";
          const fechaRegistro = new Date(registro.timestamp);
          meta.innerHTML = `Última actualización: <time datetime="${fechaRegistro.toISOString()}">${formatDateTimeForHuman(fechaRegistro)}</time>`;
          label.appendChild(meta);
        }

        item.append(checkbox, label);
        list.appendChild(item);
      });

      panel.setAttribute("aria-hidden", "false");
    }

    function calcularTurno() {
      const nombre = document.getElementById("nombre").value;
      const fechaStr = document.getElementById("fecha").value;
      const anchorToggle = document.getElementById("anchor-toggle");
      const anchorStr = document.getElementById("anchor").value;

      if (!nombre || !fechaStr) {
        hideCheckinPanel();
        setResultado("<strong>⚠️ Debes seleccionar un nombre y una fecha.</strong>", "warning");
        return;
      }

      const fecha = parseDateOrNull(fechaStr);
      if (!fecha) {
        hideCheckinPanel();
        setResultado("<strong>❌ Fecha inválida.</strong>", "error");
        return;
      }

      let base = parseDateOrNull(BASE_DATE_ISO);

      if (anchorToggle.checked) {
        const anclada = parseDateOrNull(anchorStr);
        if (!anclada) {
          hideCheckinPanel();
          setResultado("<strong>⚠️ Activas el anclaje pero la fecha es inválida.</strong>", "warning");
          return;
        }
        base = anclada;
      }

      const semanasPasadas = semanasEntre(base, fecha);
      const idxSemana = ((semanasPasadas % 4) + 4) % 4;
      const ciclo = idxSemana + 1;

      let tarea = null;
      const nombreNormalizado = norm(nombre);
      for (let j = 0; j < TAREAS.length; j++) {
        if (norm(CUADRANTE[idxSemana][j]) === nombreNormalizado) {
          tarea = TAREAS[j];
          break;
        }
      }

      const fechaLarga = fecha.toLocaleDateString("es-ES", {
        weekday: "long",
        year: "numeric",
        month: "long",
        day: "numeric"
      });
      const fechaHumana = fechaLarga.charAt(0).toUpperCase() + fechaLarga.slice(1);
      const fechaISO = fecha.toISOString().slice(0, 10);

      let html = `<div class="pill accent">Semana ${ciclo} / 4</div>`;
      html += `<p><strong>Fecha:</strong> ${fechaHumana}</p>`;

      const baseIso = base.toISOString().slice(0, 10);
      const baseHuman = base.toLocaleDateString("es-ES", {
        weekday: "long",
        year: "numeric",
        month: "long",
        day: "numeric"
      });

      html += `<p><strong>Semana 1 anclada:</strong> ${baseHuman.charAt(0).toUpperCase() + baseHuman.slice(1)}</p>`;

      if (tarea) {
        html += `<p>✅ A <strong>${nombre}</strong> le corresponde: <strong>${tarea}</strong>.</p>`;
        setResultado(html, "success");
      } else {
        html += `<p>⚠️ Nombre no encontrado. Usa: Alberto, Irene, Victor o Murci.</p>`;
        setResultado(html, "warning");
      }

      renderCheckinPanel(idxSemana, fechaISO, baseIso, fechaHumana);
    }
  </script>
</body>
</html>
